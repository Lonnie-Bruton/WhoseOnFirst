<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Members - WhoseOnFirst</title>

    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css" rel="stylesheet">

    <!-- Load sidebar component -->
    <script src="/js/sidebar-loader.js" defer></script>

    <style>
        /* Logo SVG styling */
        .logo-svg {
            width: 32px;
            height: 32px;
        }

        /* Page background for better card separation */
        .page-body {
            background-color: #f1f5f9;
        }

        /* Info alert styling */
        .alert-info {
            background-color: #dbeafe !important;
            border: 1px solid #60a5fa !important;
        }

        .alert-info .alert-title {
            color: #1e40af !important;
        }

        .alert-info .text-muted {
            color: #6c757d !important;
        }

        /* Team member color palette - 16 unique WCAG AA compliant colors */
        .team-color-1  { background-color: #1e40af; color: white; } /* Blue */
        .team-color-2  { background-color: #dc2626; color: white; } /* Red */
        .team-color-3  { background-color: #059669; color: white; } /* Green */
        .team-color-4  { background-color: #d97706; color: white; } /* Amber */
        .team-color-5  { background-color: #9333ea; color: white; } /* Purple */
        .team-color-6  { background-color: #0891b2; color: white; } /* Cyan */
        .team-color-7  { background-color: #ea580c; color: white; } /* Orange */
        .team-color-8  { background-color: #be185d; color: white; } /* Pink */
        .team-color-9  { background-color: #0f766e; color: white; } /* Teal */
        .team-color-10 { background-color: #a16207; color: white; } /* Yellow */
        .team-color-11 { background-color: #6b21a8; color: white; } /* Deep Purple */
        .team-color-12 { background-color: #b91c1c; color: white; } /* Dark Red */
        .team-color-13 { background-color: #1e3a8a; color: white; } /* Navy */
        .team-color-14 { background-color: #15803d; color: white; } /* Forest Green */
        .team-color-15 { background-color: #c2410c; color: white; } /* Rust */
        .team-color-16 { background-color: #7e22ce; color: white; } /* Violet */

        /* Member cards - enhanced shadows and white background */
        .member-card {
            transition: all 0.2s;
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .member-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        .member-card.draggable {
            cursor: move;
        }
        .member-card.sortable-ghost {
            opacity: 0.5;
        }
        .member-card.sortable-drag {
            transform: rotate(2deg);
        }

        /* Rotation number badge - high contrast */
        .rotation-badge {
            background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            font-size: 1.5rem;
            font-weight: 700;
            padding: 0.6rem 0.9rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(30, 58, 138, 0.3);
            min-width: 50px;
            text-align: center;
        }

        /* Avatar styling */
        .avatar-initials {
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .logo-svg {
            width: 32px;
            height: 32px;
        }

        #saveOrderBtn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
    </style>

    <!-- Shared team color utilities -->
    <script src="/js/team-colors.js"></script>
</head>
<body data-page="team-members">
    <div class="page">
        <!-- Sidebar Component (loaded via JavaScript) -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <div class="page-wrapper">
            <div class="page-header">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <div class="page-pretitle">Management</div>
                            <h2 class="page-title">Team Members</h2>
                        </div>
                    </div>
                    <div class="row g-2 align-items-center mt-2">
                        <div class="col-auto">
                            <select class="form-select" id="filterSelect" onchange="applyFilter()">
                                <option value="active" selected>Active Members</option>
                                <option value="inactive">Inactive Members</option>
                            </select>
                        </div>
                        <div class="col"></div>
                        <div class="col-auto">
                            <button class="btn btn-ghost-primary admin-only me-2" data-bs-toggle="modal" data-bs-target="#escalationModal" title="Configure escalation contacts">
                                <i class="ti ti-alert-triangle me-2"></i>
                                Escalation Contacts
                            </button>
                            <button class="btn btn-primary admin-only" data-bs-toggle="modal" data-bs-target="#addMemberModal">
                                <i class="ti ti-plus me-2"></i>
                                Add Team Member
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page-body">
                <div class="container-xl">
                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-5" style="display:none;">
                        <div class="spinner-border text-primary mb-3"></div>
                        <p class="text-muted">Loading team members...</p>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-5" style="display:none; background: white; border-radius: 12px; padding: 3rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        <i class="ti ti-users-group" style="font-size: 64px; color: #94a3b8;"></i>
                        <h3 class="mt-3" style="color: #1e293b; font-weight: 600;">No team members yet</h3>
                        <p class="text-muted" style="font-size: 0.95rem;">Get started by adding your first team member</p>
                        <button class="btn btn-primary admin-only mt-2" data-bs-toggle="modal" data-bs-target="#addMemberModal" style="font-weight: 500;">
                            <i class="ti ti-plus me-2"></i>
                            Add Team Member
                        </button>
                    </div>

                    <!-- Drag-and-Drop Hint -->
                    <div class="alert alert-info mb-4" id="dragHint" style="display:none;">
                        <div class="d-flex">
                            <div>
                                <i class="ti ti-arrows-move me-2"></i>
                            </div>
                            <div>
                                <h4 class="alert-title">Tips</h4>
                                <div class="text-muted">
                                    Drag and drop members to change their rotation order. Click "Save Order" when done.
                                    Hold <kbd style="background: #1e40af; color: white; padding: 0.1rem 0.4rem; border-radius: 3px; font-size: 0.85rem;">Shift</kbd> + click "Deactivate" to permanently delete a member.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Member Cards -->
                    <div class="row row-cards" id="membersContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Order Floating Button -->
    <button id="saveOrderBtn" class="btn btn-success btn-lg shadow-lg admin-only" onclick="saveRotationOrder()">
        <i class="ti ti-device-floppy me-2"></i>
        Save Rotation Order
    </button>

    <!-- Add Member Modal -->
    <div class="modal fade" id="addMemberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Team Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addMemberForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label required">Full Name</label>
                            <input type="text" class="form-control" name="name" placeholder="John Doe" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label required">Primary Phone</label>
                            <input type="tel" class="form-control" name="phone" placeholder="+19185551234" required pattern="^\+1\d{10}$">
                            <small class="form-hint">Office phone (required)</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Secondary Phone (Optional)</label>
                            <input type="tel" class="form-control" name="secondary_phone" placeholder="+19185551234" pattern="^\+1\d{10}$">
                            <small class="form-hint">Personal phone for redundancy (optional)</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="addMemberBtn">
                            <i class="ti ti-plus me-2"></i>
                            Add Member
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Member Modal -->
    <div class="modal fade" id="editMemberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Team Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editMemberForm">
                    <input type="hidden" id="editMemberId">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label required">Full Name</label>
                            <input type="text" class="form-control" id="editName" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label required">Primary Phone</label>
                            <input type="tel" class="form-control" id="editPhone" name="phone" required pattern="^\+1\d{10}$">
                            <small class="form-hint">Office phone (required)</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Secondary Phone (Optional)</label>
                            <input type="tel" class="form-control" id="editSecondaryPhone" name="secondary_phone" pattern="^\+1\d{10}$">
                            <small class="form-hint">Personal phone for redundancy (optional)</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="editMemberBtn">
                            <i class="ti ti-check me-2"></i>
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteMemberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="ti ti-alert-triangle me-2"></i>
                        Permanently Delete Team Member
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <form id="deleteMemberForm">
                    <input type="hidden" id="deleteMemberId">
                    <input type="hidden" id="deleteMemberName">
                    <div class="modal-body">
                        <div class="alert alert-danger" style="background-color: #fee2e2; border: 1px solid #dc2626; color: #991b1b;">
                            <strong>⚠️ Warning:</strong> This action cannot be undone!
                        </div>
                        <p class="mb-3">
                            You are about to <strong>permanently delete</strong> this team member:
                        </p>
                        <div class="card mb-3" style="background-color: #f8fafc; border: 1px solid #e2e8f0;">
                            <div class="card-body">
                                <h4 class="mb-1" id="deleteConfirmName" style="color: #1e293b; font-weight: 600;"></h4>
                                <div class="text-muted" id="deleteConfirmPhone"></div>
                            </div>
                        </div>
                        <p class="text-danger mb-3" style="font-size: 0.9rem;">
                            <strong>This will:</strong>
                        </p>
                        <ul class="text-danger mb-3" style="font-size: 0.9rem;">
                            <li>Permanently remove this member from the database</li>
                            <li>Delete all schedule history and assignments</li>
                            <li>Cannot be recovered</li>
                        </ul>
                        <p class="mb-2"><strong>To confirm, type the member's name exactly:</strong></p>
                        <input type="text" class="form-control" id="deleteConfirmInput"
                               placeholder="Type member name to confirm"
                               autocomplete="off" required>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger" id="deleteMemberBtn" disabled>
                            <i class="ti ti-trash me-2"></i>
                            Delete Permanently
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Escalation Contacts Modal -->
    <div class="modal fade" id="escalationModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="ti ti-alert-triangle me-2"></i>
                        Escalation Contacts
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="escalationForm">
                    <div class="modal-body">
                        <!-- Info Alert -->
                        <div class="alert alert-info mb-4">
                            <div class="d-flex">
                                <div>
                                    <i class="ti ti-info-circle me-2"></i>
                                </div>
                                <div>
                                    <h4 class="alert-title">About Escalation Contacts</h4>
                                    <div class="text-muted">
                                        Escalation contacts are <strong>fixed contacts</strong> displayed on the dashboard alongside rotating on-call assignments.
                                        They <strong>do not rotate</strong> and <strong>do not receive automated notifications</strong>.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enable Toggle -->
                        <div class="mb-4">
                            <label class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="escalationEnabled" checked>
                                <span class="form-check-label">Display escalation contacts on dashboard</span>
                            </label>
                        </div>

                        <!-- Primary Escalation Contact -->
                        <h6 class="mb-3">Primary Escalation Contact (1st)</h6>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" id="primaryName" placeholder="First Last" maxlength="100">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="primaryPhone" placeholder="+19185551234" pattern="^\+1\d{10}$">
                                <small class="form-hint">Format: +1XXXXXXXXXX (E.164)</small>
                            </div>
                        </div>

                        <!-- Secondary Escalation Contact -->
                        <h6 class="mb-3">Secondary Escalation Contact (2nd)</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Name</label>
                                <input type="text" class="form-control" id="secondaryName" placeholder="First Last" maxlength="100">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="secondaryPhone" placeholder="+19185551234" pattern="^\+1\d{10}$">
                                <small class="form-hint">Format: +1XXXXXXXXXX (E.164)</small>
                            </div>
                        </div>

                        <!-- Weekly Schedule Summary -->
                        <hr class="my-4">
                        <h6 class="mb-3">
                            <i class="ti ti-calendar-week me-2"></i>
                            Weekly Schedule Summary
                        </h6>
                        <div class="alert alert-info mb-3">
                            <div class="d-flex">
                                <div>
                                    <i class="ti ti-info-circle me-2"></i>
                                </div>
                                <div class="text-muted small">
                                    Send a weekly SMS schedule summary to escalation contacts every <strong>Monday at 8:00 AM CST</strong>.
                                    The message shows the upcoming 7-day schedule with team member names and phone numbers.
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="weeklyEnabled">
                                <span class="form-check-label">Send weekly schedule summary to escalation contacts</span>
                            </label>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-ghost-secondary btn-sm" id="testWeeklySummaryBtn">
                                <i class="ti ti-send me-2"></i>
                                Test Weekly Summary Now
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveEscalationBtn">
                            <i class="ti ti-check me-2"></i>
                            Save Configuration
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script>
        const API_BASE_URL = '';  // Use same origin as current page
        const API_BASE = '/api/v1';
        let currentUser = null;
        let allMembers = [];
        let activeMembers = [];  // For consistent color calculation
        let currentFilter = 'active';  // Default to active members
        let sortableInstance = null;
        let orderChanged = false;

        // Authentication guard - wait for sidebar to load
        window.addEventListener('sidebarLoaded', async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/auth/me`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    window.location.href = '/login.html';
                    return;
                }

                currentUser = await response.json();

                // Update user info display
                document.getElementById('usernameDisplay').textContent = currentUser.username;

                // Set role display and icon based on user role
                const roleIcon = document.getElementById('userRoleIcon').querySelector('i');
                if (currentUser.role === 'admin') {
                    document.getElementById('userRoleDisplay').textContent = 'Administrator';
                    roleIcon.className = 'ti ti-shield-check';
                } else {
                    document.getElementById('userRoleDisplay').textContent = 'Viewer';
                    roleIcon.className = 'ti ti-eye';
                }

                // Hide admin-only features for viewers
                if (currentUser.role === 'viewer') {
                    // Hide all create/edit/delete buttons and menu items
                    const adminButtons = document.querySelectorAll('.admin-only');
                    adminButtons.forEach(btn => btn.style.display = 'none');

                    // Disable drag-and-drop for viewers
                    currentFilter = 'active';
                }

                // Wire up logout button
                document.getElementById('logoutBtn').addEventListener('click', async function(e) {
                    e.preventDefault();
                    try {
                        await fetch(`${API_BASE_URL}/api/v1/auth/logout`, {
                            method: 'POST',
                            credentials: 'include'
                        });
                    } catch (error) {
                        console.error('Logout error:', error);
                    }
                    window.location.href = '/login.html';
                });

                await loadTeamMembersData();
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login.html';
            }
        });

        async function loadTeamMembersData() {
            await loadMembers();
        }

        async function loadMembers() {
            showLoading(true);
            try {
                const response = await fetch(`${API_BASE}/team-members/`, {
                    credentials: 'include'
                });
                if (!response.ok) throw new Error('Failed to load members');

                allMembers = await response.json();

                // Create activeMembers array for consistent color calculation
                activeMembers = allMembers.filter(m => m.is_active);

                // Sort by rotation_order (with nulls last), then by ID
                allMembers.sort((a, b) => {
                    if (a.rotation_order === null && b.rotation_order === null) return a.id - b.id;
                    if (a.rotation_order === null) return 1;
                    if (b.rotation_order === null) return -1;
                    return a.rotation_order - b.rotation_order;
                });

                renderMembers();
                showLoading(false);
            } catch (error) {
                console.error('Error loading members:', error);
                showLoading(false);
                showError('Failed to load team members. Please check if the backend server is running.');
            }
        }

        function getInitials(name) {
            return name
                .split(' ')
                .map(word => word[0])
                .join('')
                .toUpperCase()
                .substring(0, 2);
        }

        function renderMembers() {
            const container = document.getElementById('membersContainer');
            const dragHint = document.getElementById('dragHint');
            const emptyState = document.getElementById('emptyState');

            // Filter members based on current filter
            const filteredMembers = allMembers.filter(member => {
                if (currentFilter === 'active') return member.is_active;
                if (currentFilter === 'inactive') return !member.is_active;
                return true;
            });

            if (filteredMembers.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                dragHint.style.display = 'none';
                return;
            }

            emptyState.style.display = 'none';
            // Only show drag hint for active members with 2+ members
            dragHint.style.display = (currentFilter === 'active' && filteredMembers.length > 1) ? 'block' : 'none';

            container.innerHTML = filteredMembers.map((member, index) => `
                <div class="col-md-6 col-lg-4" data-member-id="${member.id}">
                    <div class="card member-card ${currentFilter === 'active' ? 'draggable' : ''}" style="position: relative;">
                        ${member.is_active && member.rotation_order !== null ? `
                            <div style="position: absolute; top: 16px; right: 16px; z-index: 10;">
                                <div class="rotation-badge">
                                    ${member.rotation_order + 1}
                                </div>
                            </div>
                        ` : ''}
                        <div class="card-body" style="padding: 1.5rem;">
                            <div class="d-flex align-items-center mb-3">
                                <span class="avatar avatar-lg me-3 ${getTeamColor(member.id, activeMembers)} avatar-initials">
                                    ${getInitials(member.name)}
                                </span>
                                <div class="flex-fill">
                                    <h3 class="card-title mb-1" style="font-size: 1.1rem; font-weight: 600; color: #1e293b;">
                                        ${escapeHtml(member.name)}
                                    </h3>
                                    <div class="text-muted" style="font-size: 0.875rem;">
                                        ${escapeHtml(member.phone)}
                                    </div>
                                </div>
                            </div>
                            <div class="btn-list mt-2">
                                <button class="btn btn-sm btn-outline-primary admin-only" onclick="editMember(${member.id})" style="font-weight: 500;">
                                    <i class="ti ti-edit"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-${member.is_active ? 'danger' : 'success'} admin-only"
                                        onclick="toggleActive(event, ${member.id}, ${member.is_active}, '${escapeHtml(member.name)}', '${escapeHtml(member.phone)}')" style="font-weight: 500;">
                                    <i class="ti ti-user-${member.is_active ? 'off' : 'check'}"></i>
                                    ${member.is_active ? 'Deactivate' : 'Activate'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            // Initialize drag-and-drop only for active members and admin/editor roles
            if (currentFilter === 'active' && currentUser && currentUser.role !== 'viewer') {
                initSortable();
            }
        }

        function initSortable() {
            const container = document.getElementById('membersContainer');
            if (sortableInstance) {
                sortableInstance.destroy();
            }

            sortableInstance = Sortable.create(container, {
                animation: 150,
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                onEnd: function() {
                    orderChanged = true;
                    document.getElementById('saveOrderBtn').style.display = 'block';
                }
            });
        }

        async function saveRotationOrder() {
            // Prevent saving for viewers
            if (currentUser && currentUser.role === 'viewer') {
                showError('You do not have permission to reorder team members');
                return;
            }

            const container = document.getElementById('membersContainer');
            const memberCards = container.querySelectorAll('[data-member-id]');
            const orderMapping = {};

            memberCards.forEach((card, index) => {
                const memberId = parseInt(card.getAttribute('data-member-id'));
                orderMapping[memberId] = index;
            });

            const btn = document.getElementById('saveOrderBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

            try {
                const response = await fetch(`${API_BASE}/team-members/reorder`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ order_mapping: orderMapping })
                });

                if (!response.ok) {
                    const error = await response.json();
                    const errorMsg = error.detail || JSON.stringify(error) || 'Failed to update rotation order';
                    throw new Error(errorMsg);
                }

                orderChanged = false;
                btn.style.display = 'none';
                showSuccess('✅ Rotation order saved successfully!');
                await loadMembers(); // Reload to show updated order values

            } catch (error) {
                console.error('Error saving order:', error);
                showError('❌ ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="ti ti-device-floppy me-2"></i>Save Rotation Order';
            }
        }

        // Add Member
        document.getElementById('addMemberForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Prevent form submission for viewers
            if (currentUser && currentUser.role === 'viewer') {
                showError('You do not have permission to add team members');
                return;
            }

            const formData = new FormData(e.target);
            const btn = document.getElementById('addMemberBtn');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';

            try {
                const response = await fetch(`${API_BASE}/team-members/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        name: formData.get('name'),
                        phone: formData.get('phone'),
                        secondary_phone: formData.get('secondary_phone') || null
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to add member');
                }

                // Success - reload page to ensure clean state
                showSuccess('✅ Team member added successfully!');
                setTimeout(() => {
                    window.location.reload();
                }, 500);

            } catch (error) {
                showError('❌ ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="ti ti-plus me-2"></i>Add Member';
            }
        });

        // Edit Member
        async function editMember(id) {
            // Prevent editing for viewers
            if (currentUser && currentUser.role === 'viewer') {
                showError('You do not have permission to edit team members');
                return;
            }

            const member = allMembers.find(m => m.id === id);
            if (!member) return;

            document.getElementById('editMemberId').value = member.id;
            document.getElementById('editName').value = member.name;
            document.getElementById('editPhone').value = member.phone;
            document.getElementById('editSecondaryPhone').value = member.secondary_phone || '';

            new bootstrap.Modal(document.getElementById('editMemberModal')).show();
        }

        document.getElementById('editMemberForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Prevent form submission for viewers
            if (currentUser && currentUser.role === 'viewer') {
                showError('You do not have permission to edit team members');
                return;
            }

            const memberId = document.getElementById('editMemberId').value;
            const formData = new FormData(e.target);
            const btn = document.getElementById('editMemberBtn');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

            try {
                const response = await fetch(`${API_BASE}/team-members/${memberId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        name: formData.get('name'),
                        phone: formData.get('phone'),
                        secondary_phone: formData.get('secondary_phone') || null
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to update member');
                }

                // Success - reload page to ensure clean state
                showSuccess('✅ Team member updated successfully!');
                setTimeout(() => {
                    window.location.reload();
                }, 500);

            } catch (error) {
                showError('❌ ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="ti ti-check me-2"></i>Save Changes';
            }
        });

        // Toggle Active/Inactive (with shift+click for permanent delete)
        async function toggleActive(event, id, currentStatus, name, phone) {
            // Prevent action for viewers
            if (currentUser && currentUser.role === 'viewer') {
                showError('You do not have permission to modify team members');
                return;
            }

            // Check if shift key was pressed during deactivate
            if (event.shiftKey && currentStatus) {
                // Shift+click on deactivate = permanent delete
                openDeleteModal(id, name, phone);
                return;
            }

            const action = currentStatus ? 'deactivate' : 'activate';
            if (!confirm(`Are you sure you want to ${action} this team member?`)) return;

            try {
                const endpoint = currentStatus ? 'DELETE' : 'POST';
                const url = currentStatus
                    ? `${API_BASE}/team-members/${id}`
                    : `${API_BASE}/team-members/${id}/activate`;

                const response = await fetch(url, {
                    method: endpoint,
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to update status');
                }

                showSuccess(`✅ Team member ${action}d successfully!`);
                await loadMembers();

            } catch (error) {
                showError('❌ ' + error.message);
            }
        }

        // Open delete confirmation modal
        function openDeleteModal(id, name, phone) {
            // Prevent action for viewers
            if (currentUser && currentUser.role === 'viewer') {
                showError('You do not have permission to delete team members');
                return;
            }

            document.getElementById('deleteMemberId').value = id;
            document.getElementById('deleteMemberName').value = name;
            document.getElementById('deleteConfirmName').textContent = name;
            document.getElementById('deleteConfirmPhone').textContent = phone;
            document.getElementById('deleteConfirmInput').value = '';
            document.getElementById('deleteMemberBtn').disabled = true;

            new bootstrap.Modal(document.getElementById('deleteMemberModal')).show();
        }

        // Enable delete button only when name matches
        document.addEventListener('DOMContentLoaded', function() {
            const deleteInput = document.getElementById('deleteConfirmInput');
            const deleteBtn = document.getElementById('deleteMemberBtn');

            deleteInput.addEventListener('input', function() {
                const expectedName = document.getElementById('deleteMemberName').value;
                deleteBtn.disabled = this.value !== expectedName;
            });
        });

        // Handle permanent delete
        document.getElementById('deleteMemberForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Prevent deletion for viewers
            if (currentUser && currentUser.role === 'viewer') {
                showError('You do not have permission to delete team members');
                return;
            }

            const memberId = document.getElementById('deleteMemberId').value;
            const memberName = document.getElementById('deleteMemberName').value;
            const btn = document.getElementById('deleteMemberBtn');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';

            try {
                const response = await fetch(`${API_BASE}/team-members/${memberId}/permanent`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to delete member');
                }

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('deleteMemberModal')).hide();

                showSuccess(`✅ ${memberName} permanently deleted`);
                await loadMembers();

            } catch (error) {
                showError('❌ ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="ti ti-trash me-2"></i>Delete Permanently';
            }
        });

        // Filter
        function applyFilter() {
            currentFilter = document.getElementById('filterSelect').value;
            renderMembers();
        }

        // Escalation Contacts
        // Load escalation config when modal is opened
        document.getElementById('escalationModal').addEventListener('show.bs.modal', async function() {
            try {
                const response = await fetch(`${API_BASE}/settings/escalation`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to load escalation config');
                }

                const config = await response.json();

                // Populate form fields
                document.getElementById('escalationEnabled').checked = config.enabled || false;
                document.getElementById('primaryName').value = config.primary_name || '';
                document.getElementById('primaryPhone').value = config.primary_phone || '';
                document.getElementById('secondaryName').value = config.secondary_name || '';
                document.getElementById('secondaryPhone').value = config.secondary_phone || '';

                // Load weekly summary setting
                const weeklyResponse = await fetch(`${API_BASE}/settings/escalation-weekly`, {
                    credentials: 'include'
                });
                if (weeklyResponse.ok) {
                    const weeklySetting = await weeklyResponse.json();
                    document.getElementById('weeklyEnabled').checked = weeklySetting.enabled || false;
                }

            } catch (error) {
                console.error('Error loading escalation config:', error);
                showError('❌ Failed to load escalation configuration');
            }
        });

        // Save escalation config
        document.getElementById('escalationForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Prevent form submission for viewers
            if (currentUser && currentUser.role === 'viewer') {
                showError('You do not have permission to update escalation contacts');
                return;
            }

            const btn = document.getElementById('saveEscalationBtn');
            const enabled = document.getElementById('escalationEnabled').checked;
            const primaryName = document.getElementById('primaryName').value.trim();
            const primaryPhone = document.getElementById('primaryPhone').value.trim();
            const secondaryName = document.getElementById('secondaryName').value.trim();
            const secondaryPhone = document.getElementById('secondaryPhone').value.trim();
            const weeklyEnabled = document.getElementById('weeklyEnabled').checked;

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

            try {
                // Save escalation contacts
                const response = await fetch(`${API_BASE}/settings/escalation`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        enabled: enabled,
                        primary_name: primaryName || null,
                        primary_phone: primaryPhone || null,
                        secondary_name: secondaryName || null,
                        secondary_phone: secondaryPhone || null
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save escalation config');
                }

                // Save weekly summary setting
                const weeklyResponse = await fetch(`${API_BASE}/settings/escalation-weekly`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        enabled: weeklyEnabled
                    })
                });

                if (!weeklyResponse.ok) {
                    const error = await weeklyResponse.json();
                    throw new Error(error.detail || 'Failed to save weekly summary setting');
                }

                // SUCCESS: Close modal and wait for Bootstrap to fully complete
                const modal = bootstrap.Modal.getInstance(document.getElementById('escalationModal'));
                const modalElement = document.getElementById('escalationModal');

                // Listen for Bootstrap's 'hidden' event (fires when animation completes)
                modalElement.addEventListener('hidden.bs.modal', function onHidden() {
                    // Modal is FULLY closed, Bootstrap cleanup complete
                    // NOW it's safe to show blocking alert

                    // Extra cleanup for safety (Bootstrap should handle this, but doesn't always)
                    setTimeout(() => {
                        document.querySelector('.modal-backdrop')?.remove();
                        document.body.classList.remove('modal-open');
                        document.body.style.removeProperty('padding-right');
                        document.body.style.removeProperty('overflow');
                    }, 50);

                    // Show success alert AFTER modal is completely gone
                    showSuccess('✅ Escalation contacts saved successfully!');

                    // Remove this event listener (one-time use)
                    modalElement.removeEventListener('hidden.bs.modal', onHidden);
                });

                // Trigger the modal close (will fire 'hidden.bs.modal' when done)
                if (modal) {
                    modal.hide();
                }

            } catch (error) {
                // ERROR: Close modal and wait for Bootstrap to fully complete
                const modal = bootstrap.Modal.getInstance(document.getElementById('escalationModal'));
                const modalElement = document.getElementById('escalationModal');

                // Listen for Bootstrap's 'hidden' event
                modalElement.addEventListener('hidden.bs.modal', function onHidden() {
                    // Modal is FULLY closed, Bootstrap cleanup complete

                    // Extra cleanup for safety
                    setTimeout(() => {
                        document.querySelector('.modal-backdrop')?.remove();
                        document.body.classList.remove('modal-open');
                        document.body.style.removeProperty('padding-right');
                        document.body.style.removeProperty('overflow');
                    }, 50);

                    // Show error alert AFTER modal is completely gone
                    showError('❌ ' + error.message);

                    // Remove this event listener (one-time use)
                    modalElement.removeEventListener('hidden.bs.modal', onHidden);
                });

                // Trigger the modal close
                if (modal) {
                    modal.hide();
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="ti ti-check me-2"></i>Save Configuration';
            }
        });

        // Test Weekly Summary button handler
        document.getElementById('testWeeklySummaryBtn').addEventListener('click', async function() {
            // Prevent action for viewers
            if (currentUser && currentUser.role === 'viewer') {
                showError('You do not have permission to trigger weekly summaries');
                return;
            }

            const btn = this;
            const originalHTML = btn.innerHTML;

            // Confirm action
            if (!confirm('Send a weekly schedule summary to all configured escalation contacts now?')) {
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';

            try {
                const response = await fetch(`${API_BASE}/schedules/notifications/weekly-summary/trigger`, {
                    method: 'POST',
                    credentials: 'include'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || error.message || 'Failed to send weekly summary');
                }

                const result = await response.json();

                // Show detailed result
                if (result.status === 'success') {
                    // Handle nested result structure
                    const counts = result.result || result;
                    if (counts.successful !== undefined) {
                        showSuccess(`✅ Weekly summary sent!\n\nSuccessful: ${counts.successful}\nFailed: ${counts.failed}\nTotal: ${counts.total}`);
                    } else {
                        showSuccess(`✅ ${result.message || 'Weekly summary sent successfully!'}`);
                    }
                } else {
                    showError(`⚠️ ${result.message}`);
                }

            } catch (error) {
                showError('❌ ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        });

        // Utility Functions
        function showLoading(show) {
            document.getElementById('loadingState').style.display = show ? 'block' : 'none';
            document.getElementById('membersContainer').style.display = show ? 'none' : '';
        }

        function showSuccess(message) {
            alert(message);
        }

        function showError(message) {
            alert(message);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
