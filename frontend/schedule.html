<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schedule Generation - WhoseOnFirst</title>

    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css" rel="stylesheet">

    <!-- Load sidebar component -->
    <script src="/js/sidebar-loader.js" defer></script>

    <style>
        /* Page background for better card separation */
        .page-body {
            background-color: #f1f5f9;
        }

        .logo-svg {
            width: 32px;
            height: 32px;
        }

        /* Card styling consistent with other pages */
        .card {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Team member color blocks */
        .team-member-block {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 2px solid transparent;
        }

        .team-member-block:hover {
            border-color: rgba(0, 0, 0, 0.1);
        }

        .team-member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            margin-right: 12px;
        }

        /* Team colors (same as team-members page) */
        /* Team Member Colors - 16 unique WCAG AA compliant colors */
        .team-color-1  { background-color: #1e40af; color: white; } /* Blue */
        .team-color-2  { background-color: #dc2626; color: white; } /* Red */
        .team-color-3  { background-color: #059669; color: white; } /* Green */
        .team-color-4  { background-color: #d97706; color: white; } /* Amber */
        .team-color-5  { background-color: #9333ea; color: white; } /* Purple */
        .team-color-6  { background-color: #0891b2; color: white; } /* Cyan */
        .team-color-7  { background-color: #ea580c; color: white; } /* Orange */
        .team-color-8  { background-color: #be185d; color: white; } /* Pink */
        .team-color-9  { background-color: #0f766e; color: white; } /* Teal */
        .team-color-10 { background-color: #a16207; color: white; } /* Yellow */
        .team-color-11 { background-color: #6b21a8; color: white; } /* Deep Purple */
        .team-color-12 { background-color: #b91c1c; color: white; } /* Dark Red */
        .team-color-13 { background-color: #1e3a8a; color: white; } /* Navy */
        .team-color-14 { background-color: #15803d; color: white; } /* Forest Green */
        .team-color-15 { background-color: #c2410c; color: white; } /* Rust */
        .team-color-16 { background-color: #7e22ce; color: white; } /* Violet */

        /* Day cards for first week preview */
        .day-card {
            border-width: 2px;
        }

        .day-card-header {
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            text-align: center;
            margin-bottom: 8px;
        }

        .day-card-body {
            text-align: center;
        }
    </style>
</head>
<body data-page="schedule">
    <div class="page">
        <!-- Sidebar Component (loaded via JavaScript) -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <div class="page-wrapper">
            <div class="page-header">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <div class="page-pretitle">Notification</div>
                            <h2 class="page-title">Schedule Generation</h2>
                        </div>
                    </div>
                </div>
            </div>

            <div class="page-body">
                <div class="container-xl">
                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-lg-7">
                            <!-- Generate Notification Schedule Card -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="ti ti-calendar-plus me-2"></i>
                                        Generate Notification Schedule
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <form id="createScheduleForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label required">Start Date</label>
                                                <input type="date" class="form-control" id="startDate" required>
                                                <small class="form-hint">First day of schedule (typically Monday)</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label required">Duration</label>
                                                <select class="form-select" id="weeks" required>
                                                    <option value="1">1 Week</option>
                                                    <option value="2">2 Weeks</option>
                                                    <option value="4">4 Weeks (1 Month)</option>
                                                    <option value="8">8 Weeks (2 Months)</option>
                                                    <option value="12" selected>12 Weeks (Quarter) ⭐</option>
                                                    <option value="24">24 Weeks (6 Months)</option>
                                                    <option value="52">52 Weeks (1 Year)</option>
                                                </select>
                                                <small class="form-hint">Generate 12+ weeks for less maintenance</small>
                                            </div>
                                        </div>

                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="autoRenewEnabled" checked>
                                            <label class="form-check-label" for="autoRenewEnabled">
                                                <strong>Auto-renew schedule</strong>
                                                <small class="text-muted">(Automatically extend when running low)</small>
                                            </label>
                                            <small class="form-hint d-block mt-1">
                                                <i class="ti ti-info-circle"></i>
                                                System will automatically generate new schedules when less than 4 weeks remain
                                            </small>
                                        </div>

                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="forceRegenerate">
                                            <label class="form-check-label" for="forceRegenerate">
                                                Force regenerate (delete existing schedules and create new ones)
                                            </label>
                                        </div>

                                        <button type="submit" class="btn btn-primary admin-only" id="createScheduleBtn">
                                            <i class="ti ti-calendar-plus me-2"></i>
                                            Generate Notification Schedule
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="col-lg-5">
                            <!-- Schedule Status Card -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="ti ti-calendar-stats me-2"></i>
                                        Schedule Status
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-6 mb-3">
                                            <div class="subheader">Active Team Members</div>
                                            <div class="h1 mb-0" id="activeMembersCount">-</div>
                                        </div>
                                        <div class="col-6 mb-3">
                                            <div class="subheader">Configured Shifts</div>
                                            <div class="h1 mb-0" id="shiftsCount">-</div>
                                        </div>
                                    </div>

                                    <div id="scheduleStatusDetails">
                                        <div class="text-center text-muted py-3">
                                            <i class="ti ti-calendar-off icon-lg mb-2"></i>
                                            <p class="mb-0">No upcoming schedules</p>
                                            <small>Generate a schedule to get started</small>
                                        </div>
                                    </div>

                                    <button type="button" class="btn btn-outline-primary w-100 mt-3 admin-only" id="exportSchedulesBtn" style="display: none;">
                                        <i class="ti ti-file-export me-2"></i>
                                        Export to CSV
                                    </button>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- 14-Day Preview Card (Full Width) -->
                    <div class="row mt-4" id="twoWeekPreviewCard" style="display: none;">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="ti ti-calendar-week me-2"></i>
                                        14 Day Preview
                                    </h3>
                                    <div class="card-actions">
                                        <span class="text-muted">Next 14 days from today</span>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="twoWeekPreview" class="row row-cols-7 g-2">
                                        <!-- 14-day preview will be rendered here (2 rows of 7) -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
    <script>
        const API_BASE_URL = '';  // Use same origin as current page
        const API_BASE = '/api/v1';
        let allTeamMembers = [];
        let allSchedules = [];
        let allShifts = [];
        let currentUser = null;

        // Get team member initials
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase();
        }

        // Get team color class for member by index
        function getTeamColor(index) {
            return `team-color-${(index % 16) + 1}`;
        }

        // Set default start date to next Monday
        function setDefaultStartDate() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const daysUntilMonday = dayOfWeek === 0 ? 1 : (8 - dayOfWeek);
            const nextMonday = new Date(today);
            nextMonday.setDate(today.getDate() + daysUntilMonday);

            const year = nextMonday.getFullYear();
            const month = String(nextMonday.getMonth() + 1).padStart(2, '0');
            const day = String(nextMonday.getDate()).padStart(2, '0');

            document.getElementById('startDate').value = `${year}-${month}-${day}`;
        }

        // Load team members in rotation order
        async function loadTeamMembers() {
            try {
                const response = await fetch(`${API_BASE}/team-members/?active_only=true`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    allTeamMembers = await response.json();
                    // Sort by rotation_order
                    allTeamMembers.sort((a, b) => {
                        if (a.rotation_order === null) return 1;
                        if (b.rotation_order === null) return -1;
                        return a.rotation_order - b.rotation_order;
                    });
                    document.getElementById('activeMembersCount').textContent = allTeamMembers.length;
                }
            } catch (error) {
                console.error('Error loading team members:', error);
            }
        }

        // Load shifts
        async function loadShifts() {
            try {
                const response = await fetch(`${API_BASE}/shifts/`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    allShifts = await response.json();
                    document.getElementById('shiftsCount').textContent = allShifts.length;
                }
            } catch (error) {
                console.error('Error loading shifts:', error);
            }
        }

        // Load schedule status
        async function loadScheduleStatus() {
            try {
                // Fetch all upcoming schedules (use a large number to get everything)
                const response = await fetch(`${API_BASE}/schedules/upcoming?weeks=104`, {
                    credentials: 'include'
                });
                if (response.ok) {
                    allSchedules = await response.json();
                    renderScheduleStatus();
                    if (allSchedules.length > 0) {
                        render14DayPreview();
                    }
                } else {
                    document.getElementById('scheduleStatusDetails').innerHTML = `
                        <div class="text-center text-muted py-3">
                            <i class="ti ti-calendar-off icon-lg mb-2"></i>
                            <p class="mb-0">No upcoming schedules</p>
                            <small>Generate a schedule to get started</small>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading schedules:', error);
            }
        }

        // Render schedule status
        function renderScheduleStatus() {
            const container = document.getElementById('scheduleStatusDetails');

            if (allSchedules.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="ti ti-calendar-off icon-lg mb-2"></i>
                        <p class="mb-0">No upcoming schedules</p>
                        <small>Generate a schedule to get started</small>
                    </div>
                `;
                document.getElementById('exportSchedulesBtn').style.display = 'none';
                document.getElementById('twoWeekPreviewCard').style.display = 'none';
                return;
            }

            // Calculate stats
            const firstSchedule = allSchedules[0];
            const lastSchedule = allSchedules[allSchedules.length - 1];
            const weekCount = Math.ceil(allSchedules.length / allShifts.length);

            const startDate = new Date(firstSchedule.start_datetime).toLocaleDateString();
            const endDate = new Date(lastSchedule.end_datetime);
            const endDateStr = endDate.toLocaleDateString();

            // Calculate days until schedule ends
            const today = new Date();
            const daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
            const weeksRemaining = Math.floor(daysRemaining / 7);

            // Determine warning level
            let statusClass = 'success';
            let statusIcon = 'check';
            let statusText = 'Schedule is active';
            let showWarning = false;
            let warningText = '';

            if (weeksRemaining < 2) {
                statusClass = 'danger';
                statusIcon = 'alert-triangle';
                statusText = 'Schedule ending soon!';
                showWarning = true;
                warningText = `⚠️ Only ${daysRemaining} days remaining! Generate more weeks to avoid gaps.`;
            } else if (weeksRemaining < 4) {
                statusClass = 'warning';
                statusIcon = 'alert-circle';
                statusText = 'Schedule running low';
                showWarning = true;
                warningText = `⏰ ${weeksRemaining} weeks remaining. Consider extending the schedule.`;
            }

            container.innerHTML = `
                <div class="mb-3">
                    <div class="subheader">Upcoming Schedules</div>
                    <div class="h1 mb-0">${allSchedules.length}</div>
                </div>
                <div class="mb-3">
                    <div class="subheader">Coverage Period</div>
                    <div>${weekCount} ${weekCount === 1 ? 'Week' : 'Weeks'} (${weeksRemaining} weeks left)</div>
                </div>
                <div class="mb-3">
                    <div class="subheader">Date Range</div>
                    <div class="small">${startDate} - ${endDateStr}</div>
                </div>
                ${showWarning ? `
                    <div class="alert alert-${statusClass} mb-3 py-2">
                        <small>${warningText}</small>
                    </div>
                ` : ''}
                <div class="progress progress-sm mb-2">
                    <div class="progress-bar bg-${statusClass}" style="width: 100%"></div>
                </div>
                <div class="text-${statusClass} small">
                    <i class="ti ti-${statusIcon} me-1"></i>
                    ${statusText}
                </div>
            `;

            document.getElementById('exportSchedulesBtn').style.display = 'block';
            document.getElementById('twoWeekPreviewCard').style.display = 'block';
        }

        // Render 14-day preview (first 2 weeks = 2 rows of 7)
        function render14DayPreview() {
            const container = document.getElementById('twoWeekPreview');

            // Sort schedules by start date
            const sortedSchedules = [...allSchedules].sort((a, b) =>
                new Date(a.start_datetime) - new Date(b.start_datetime)
            );

            // Check if we have schedules
            if (sortedSchedules.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-3">No schedules available</div>';
                return;
            }

            // Build day-by-day view for first 14 days (2 rows of 7)
            const dayCards = [];
            const startDate = new Date(sortedSchedules[0].start_datetime);

            for (let i = 0; i < 14; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                const dateKey = currentDate.toISOString().split('T')[0];

                // Find schedule that covers this day
                const schedule = sortedSchedules.find(s => {
                    const schedStart = new Date(s.start_datetime);
                    const schedEnd = new Date(s.end_datetime);
                    return currentDate >= schedStart && currentDate < schedEnd;
                });

                if (schedule) {
                    const member = allTeamMembers.find(m => m.id === schedule.team_member_id);
                    const shift = allShifts.find(s => s.id === schedule.shift_id);

                    if (member && shift) {
                        const memberIndex = allTeamMembers.indexOf(member);
                        const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
                        const dateNum = currentDate.getDate();

                        dayCards.push(`
                            <div class="col">
                                <div class="card day-card border-success">
                                    <div class="card-body p-2">
                                        <div class="day-card-header">${dayName} ${dateNum}</div>
                                        <div class="day-card-body">
                                            <div class="team-member-avatar ${getTeamColor(memberIndex)} mx-auto mb-2" style="width: 48px; height: 48px; font-size: 16px;">
                                                ${getInitials(member.name)}
                                            </div>
                                            <div class="small fw-bold">${member.name}</div>
                                            <div class="badge ${shift.duration_hours === 48 ? 'bg-purple-lt' : 'bg-blue-lt'} mt-1"
                                                 style="color: ${shift.duration_hours === 48 ? '#6b21a8' : '#1e40af'}; font-weight: 600;">
                                                ${shift.duration_hours}h
                                            </div>
                                            <div class="text-muted" style="font-size: 0.7rem;">Shift ${shift.shift_number}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `);
                    }
                } else {
                    // No coverage for this day
                    const dayName = currentDate.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
                    const dateNum = currentDate.getDate();

                    dayCards.push(`
                        <div class="col">
                            <div class="card day-card border-danger">
                                <div class="card-body p-2">
                                    <div class="day-card-header">${dayName} ${dateNum}</div>
                                    <div class="day-card-body">
                                        <i class="ti ti-calendar-off text-danger" style="font-size: 2rem;"></i>
                                        <div class="small text-muted mt-1">No coverage</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `);
                }
            }

            // Container already has row classes, just insert cards
            container.innerHTML = dayCards.join('');
        }

        // Create schedule
        document.getElementById('createScheduleForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Block viewers from submitting
            if (currentUser && currentUser.role === 'viewer') {
                alert('You do not have permission to create schedules');
                return;
            }

            const startDate = document.getElementById('startDate').value;
            const weeks = parseInt(document.getElementById('weeks').value);
            const force = document.getElementById('forceRegenerate').checked;
            const autoRenewEnabled = document.getElementById('autoRenewEnabled').checked;
            const btn = document.getElementById('createScheduleBtn');

            // Convert local date to ISO datetime with CST timezone
            const startDateTime = new Date(startDate + 'T08:00:00');
            const offset = startDateTime.getTimezoneOffset();
            startDateTime.setMinutes(startDateTime.getMinutes() - offset);
            const isoDateTime = startDateTime.toISOString().replace('Z', '-06:00');

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';

            try {
                const response = await fetch(`${API_BASE}/schedules/generate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        start_date: isoDateTime,
                        weeks: weeks,
                        force: force
                    })
                });

                if (response.ok) {
                    const result = await response.json();

                    // Save auto-renewal setting
                    try {
                        await fetch(`${API_BASE}/settings/auto-renew`, {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({
                                enabled: autoRenewEnabled
                            })
                        });
                    } catch (settingsError) {
                        console.error('Failed to save auto-renewal setting:', settingsError);
                    }

                    alert(`✅ Successfully created ${result.length} schedule assignments!`);
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                } else {
                    const error = await response.json();
                    alert('❌ Error: ' + (error.detail || 'Failed to create schedule'));
                }
            } catch (error) {
                alert('❌ Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="ti ti-calendar-plus me-2"></i>Generate Notification Schedule';
            }
        });

        // Export schedules to CSV
        document.getElementById('exportSchedulesBtn').addEventListener('click', function() {
            // Block viewers from exporting
            if (currentUser && currentUser.role === 'viewer') {
                alert('You do not have permission to export schedules');
                return;
            }

            if (allSchedules.length === 0) {
                alert('No schedules to export');
                return;
            }

            // Build CSV content
            const headers = ['Week #', 'Start Date', 'End Date', 'Day(s)', 'Team Member', 'Phone', 'Shift #', 'Duration (hours)', 'Notified'];
            const rows = allSchedules.map(schedule => {
                const member = allTeamMembers.find(m => m.id === schedule.team_member_id);
                const shift = allShifts.find(s => s.id === schedule.shift_id);

                if (!member || !shift) return null;

                return [
                    schedule.week_number,
                    new Date(schedule.start_datetime).toLocaleString(),
                    new Date(schedule.end_datetime).toLocaleString(),
                    shift.day_of_week,
                    member.name,
                    member.phone,
                    shift.shift_number,
                    shift.duration_hours,
                    schedule.notified ? 'Yes' : 'No'
                ];
            }).filter(row => row !== null);

            // Create CSV string
            const csvContent = [
                headers.join(','),
                ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
            ].join('\n');

            // Download CSV file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const filename = `whoseonfirst-schedule-${new Date().toISOString().split('T')[0]}.csv`;

            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            // Show success message
            alert(`✅ Exported ${rows.length} schedules to ${filename}`);
        });

        // Main initialization function
        // Load auto-renewal setting
        async function loadAutoRenewSetting() {
            try {
                const response = await fetch(`${API_BASE}/settings/auto-renew`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const config = await response.json();
                    document.getElementById('autoRenewEnabled').checked = config.enabled;
                }
            } catch (error) {
                console.error('Failed to load auto-renewal setting:', error);
                // Default to enabled if fetch fails
                document.getElementById('autoRenewEnabled').checked = true;
            }
        }

        async function loadSchedulesData() {
            setDefaultStartDate();
            await loadTeamMembers();
            await loadShifts();
            await loadScheduleStatus();
            await loadAutoRenewSetting();
        }

        // Authentication guard - FIRST thing to execute on page load
        window.addEventListener('sidebarLoaded', async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/auth/me`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    // Not authenticated - redirect immediately
                    window.location.href = '/login.html';
                    return;
                }

                currentUser = await response.json();

                // Update user info display
                document.getElementById('usernameDisplay').textContent = currentUser.username;

                // Set role display and icon based on user role
                const roleIcon = document.getElementById('userRoleIcon').querySelector('i');
                if (currentUser.role === 'admin') {
                    document.getElementById('userRoleDisplay').textContent = 'Administrator';
                    roleIcon.className = 'ti ti-shield-check';
                } else {
                    document.getElementById('userRoleDisplay').textContent = 'Viewer';
                    roleIcon.className = 'ti ti-eye';
                }

                // Hide admin-only features for viewers
                if (currentUser.role === 'viewer') {
                    const adminButtons = document.querySelectorAll('.admin-only');
                    adminButtons.forEach(btn => btn.style.display = 'none');
                }

                // Wire up logout button
                document.getElementById('logoutBtn').addEventListener('click', async function(e) {
                    e.preventDefault();
                    try {
                        await fetch(`${API_BASE_URL}/api/v1/auth/logout`, {
                            method: 'POST',
                            credentials: 'include'
                        });
                    } catch (error) {
                        console.error('Logout error:', error);
                    }
                    window.location.href = '/login.html';
                });

                // Load data after successful auth check
                await loadSchedulesData();
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login.html';
            }
        });
    </script>
</body>
</html>
