<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhoseOnFirst - Notifications</title>

    <!-- Tabler CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
    <!-- Tabler Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css" rel="stylesheet">

    <!-- Load sidebar component -->
    <script src="/js/sidebar-loader.js" defer></script>

    <style>
        /* Custom Logo Styles */
        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-svg {
            width: 32px;
            height: 32px;
        }

        /* Enhanced Cards */
        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Team Member Colors - 16 unique WCAG AA compliant colors */
        .team-color-1  { background-color: #1e40af; color: white; } /* Blue */
        .team-color-2  { background-color: #dc2626; color: white; } /* Red */
        .team-color-3  { background-color: #059669; color: white; } /* Green */
        .team-color-4  { background-color: #d97706; color: white; } /* Amber */
        .team-color-5  { background-color: #9333ea; color: white; } /* Purple */
        .team-color-6  { background-color: #0891b2; color: white; } /* Cyan */
        .team-color-7  { background-color: #ea580c; color: white; } /* Orange */
        .team-color-8  { background-color: #be185d; color: white; } /* Pink */
        .team-color-9  { background-color: #0f766e; color: white; } /* Teal */
        .team-color-10 { background-color: #a16207; color: white; } /* Yellow */
        .team-color-11 { background-color: #6b21a8; color: white; } /* Deep Purple */
        .team-color-12 { background-color: #b91c1c; color: white; } /* Dark Red */
        .team-color-13 { background-color: #1e3a8a; color: white; } /* Navy */
        .team-color-14 { background-color: #15803d; color: white; } /* Forest Green */
        .team-color-15 { background-color: #c2410c; color: white; } /* Rust */
        .team-color-16 { background-color: #7e22ce; color: white; } /* Violet */
    </style>

    <!-- Shared team color utilities -->
    <script src="/js/team-colors.js"></script>
</head>
<body data-page="notifications">
    <div class="page">
        <!-- Sidebar Component (loaded via JavaScript) -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <div class="page-wrapper">
            <!-- Page Header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <div class="page-pretitle">SMS Management</div>
                            <h2 class="page-title">Notifications</h2>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">
                                <button class="btn btn-primary admin-only" id="sendTestSMS">
                                    <i class="ti ti-send me-2"></i>
                                    Send Test SMS
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page Body -->
            <div class="page-body">
                <div class="container-xl">
                    <!-- Stats Cards -->
                    <div class="row row-deck row-cards mb-4">
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Total Sent</div>
                                        <div class="ms-auto">
                                            <span class="bg-blue text-white avatar">
                                                <i class="ti ti-send"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="h1 mb-3" id="totalSent">-</div>
                                    <div class="d-flex mb-2">
                                        <div class="text-muted">All time notifications</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">This Month</div>
                                        <div class="ms-auto">
                                            <span class="bg-green text-white avatar">
                                                <i class="ti ti-calendar"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="h1 mb-3" id="thisMonth">-</div>
                                    <div class="d-flex mb-2">
                                        <div class="text-muted">Current month</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Delivery Rate</div>
                                        <div class="ms-auto">
                                            <span class="bg-success text-white avatar">
                                                <i class="ti ti-check"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-baseline">
                                        <div class="h1 mb-0 me-2" id="deliveryRate">-</div>
                                        <div class="me-auto">
                                            <span class="text-muted" id="deliveryLabel">Calculating...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Failed</div>
                                        <div class="ms-auto">
                                            <span class="bg-red text-white avatar">
                                                <i class="ti ti-alert-circle"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="h1 mb-3" id="failedCount">-</div>
                                    <div class="d-flex mb-2">
                                        <div class="text-muted">Requires attention</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SMS Template (Editable) -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="ti ti-file-text me-2"></i>
                                        SMS Template
                                    </h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-primary admin-only" id="editTemplateBtn">
                                            <i class="ti ti-edit"></i>
                                            Edit Template
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info mb-3">
                                        <i class="ti ti-info-circle me-2"></i>
                                        This template is automatically sent to team members at 8:00 AM CST when their shift starts.
                                    </div>

                                    <!-- Read-Only View -->
                                    <div id="templateReadView">
                                        <div class="border p-3 rounded bg-light">
                                            <div class="mb-2"><strong>Send Time:</strong> 8:00 AM CST</div>
                                            <div class="mb-2"><strong>Status:</strong> <span class="badge bg-success">Active</span></div>
                                            <hr>
                                            <div class="font-monospace" id="templatePreview" style="white-space: pre-wrap;"></div>
                                        </div>
                                        <div class="text-muted mt-2">
                                            <small>Available variables: {name}, {start_time}, {end_time}, {duration}</small>
                                        </div>
                                    </div>

                                    <!-- Edit View (Hidden by default) -->
                                    <div id="templateEditView" style="display: none;">
                                        <div class="mb-3">
                                            <label class="form-label">Message Template</label>
                                            <textarea class="form-control font-monospace" id="templateEditor" rows="6"
                                                      placeholder="Enter your SMS template..."></textarea>
                                            <div class="form-text">
                                                Available variables: {name}, {start_time}, {end_time}, {duration}
                                            </div>
                                            <div class="form-text mt-2">
                                                <strong>Character count:</strong> <span id="charCount">0</span> / 160
                                                <span id="smsCount" class="ms-2">(1 SMS)</span>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-success admin-only" id="saveTemplateBtn">
                                                <i class="ti ti-check"></i>
                                                Save Template
                                            </button>
                                            <button class="btn btn-secondary" id="cancelTemplateBtn">
                                                <i class="ti ti-x"></i>
                                                Cancel
                                            </button>
                                            <button class="btn btn-outline-primary ms-auto admin-only" id="resetTemplateBtn">
                                                <i class="ti ti-refresh"></i>
                                                Reset to Default
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notification History -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="ti ti-history me-2"></i>
                                        Notification History
                                    </h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-outline-primary" id="refreshHistory">
                                            <i class="ti ti-refresh"></i>
                                            Refresh
                                        </button>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table card-table table-vcenter" id="notificationTable">
                                        <thead>
                                            <tr>
                                                <th>Timestamp</th>
                                                <th>Recipient</th>
                                                <th>Phone</th>
                                                <th>Status</th>
                                                <th>Twilio SID</th>
                                                <th class="w-1">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="historyTableBody">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">Loading notification history...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="card-footer">
                                    <div class="text-muted" id="historyCount">Showing 0 notifications</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message Details Modal -->
            <div class="modal modal-blur fade" id="messageDetailsModal" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="ti ti-message-circle me-2"></i>
                                SMS Message Details
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <!-- Loading State -->
                            <div id="messageDetailsLoading" class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <div class="mt-3 text-muted">Fetching message details from Twilio...</div>
                            </div>

                            <!-- Error State -->
                            <div id="messageDetailsError" class="alert alert-danger" style="display: none;">
                                <i class="ti ti-alert-circle me-2"></i>
                                <span id="messageDetailsErrorText"></span>
                            </div>

                            <!-- Content -->
                            <div id="messageDetailsContent" style="display: none;">
                                <!-- Message Body -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h3 class="card-title">Message Content</h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="alert alert-info mb-0">
                                            <pre class="mb-0" id="messageBody" style="white-space: pre-wrap; font-family: monospace;"></pre>
                                        </div>
                                    </div>
                                </div>

                                <!-- Delivery Details -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h3 class="card-title">Delivery Information</h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">Status</label>
                                                <div id="messageStatus"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">Direction</label>
                                                <div id="messageDirection"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">Date Sent</label>
                                                <div id="messageDateSent"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">Date Updated</label>
                                                <div id="messageDateUpdated"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">From</label>
                                                <div><code id="messageFrom"></code></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">To</label>
                                                <div><code id="messageTo"></code></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Technical Details -->
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">Technical Details</h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">Message SID</label>
                                                <div><code id="messageSid"></code></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">Number of Segments</label>
                                                <div id="messageSegments"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">Price</label>
                                                <div id="messagePrice"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label fw-bold">Error Code</label>
                                                <div id="messageErrorCode"></div>
                                            </div>
                                            <div class="col-12" id="messageErrorMessageContainer" style="display: none;">
                                                <label class="form-label fw-bold">Error Message</label>
                                                <div class="alert alert-danger mb-0" id="messageErrorMessage"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Send Manual Notification Modal -->
            <div class="modal modal-blur fade" id="manualNotificationModal" tabindex="-1" role="dialog" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="ti ti-send me-2"></i>
                                Send Manual Notification
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info mb-3">
                                <i class="ti ti-info-circle me-2"></i>
                                Send a custom SMS notification to any active team member. This bypasses the schedule system.
                            </div>

                            <!-- Recipient Selection -->
                            <div class="mb-3">
                                <label class="form-label required">Recipient</label>
                                <select class="form-select" id="manualRecipientSelect" required>
                                    <option value="">Loading team members...</option>
                                </select>
                                <div class="form-text">Select the team member to notify</div>
                            </div>

                            <!-- Message Editor -->
                            <div class="mb-3">
                                <label class="form-label required">Message</label>
                                <textarea
                                    class="form-control font-monospace"
                                    id="manualMessageText"
                                    rows="8"
                                    placeholder="WhoseOnFirst Alert&#10;&#10;Hi {name}, this is a manual notification..."
                                    required></textarea>
                                <div class="form-text">
                                    Use <code>{name}</code> to insert recipient's name
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <div class="text-muted">
                                        <strong>Characters:</strong> <span id="manualCharCount">0</span> / 160
                                    </div>
                                    <div class="text-muted">
                                        <strong>SMS:</strong> <span id="manualSmsCount">1</span>
                                    </div>
                                </div>
                                <div class="progress mt-2" style="height: 4px;">
                                    <div class="progress-bar" id="manualCharProgress" role="progressbar" style="width: 0%"></div>
                                </div>
                            </div>

                            <!-- Preview Section -->
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h4 class="card-title">Preview</h4>
                                    <div class="font-monospace text-muted" id="manualMessagePreview" style="white-space: pre-wrap; font-size: 0.875rem;">
                                        (Message preview will appear here)
                                    </div>
                                </div>
                            </div>

                            <!-- Error Display -->
                            <div id="manualNotificationError" class="alert alert-danger mt-3" style="display: none;">
                                <i class="ti ti-alert-circle me-2"></i>
                                <span id="manualNotificationErrorText"></span>
                            </div>

                            <!-- Success Display -->
                            <div id="manualNotificationSuccess" class="alert alert-success mt-3" style="display: none;">
                                <i class="ti ti-check me-2"></i>
                                <span id="manualNotificationSuccessText"></span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" id="sendManualNotificationBtn">
                                <i class="ti ti-send me-2"></i>
                                Send SMS
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
        </div>
    </div>

    <!-- Tabler JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>

    <script>
        const API_BASE_URL = '';  // Use same origin as current page
        const API_BASE = '/api/v1';
        let currentUser = null;

        // Format date/time
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        // Mask phone number
        function maskPhone(phone) {
            if (!phone || phone.length < 4) return phone;
            return phone.slice(0, -4) + 'XXXX';
        }

        // Load notification stats
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/notifications/stats?days=30`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch stats');
                }

                const stats = await response.json();

                document.getElementById('totalSent').textContent = stats.total_sent;
                document.getElementById('thisMonth').textContent = stats.this_month;
                document.getElementById('deliveryRate').textContent = stats.delivery_rate.toFixed(1) + '%';
                document.getElementById('failedCount').textContent = stats.failed_count;

                // Update delivery label based on rate
                const label = document.getElementById('deliveryLabel');
                if (stats.delivery_rate >= 95) {
                    label.textContent = 'Excellent';
                    label.className = 'text-green';
                } else if (stats.delivery_rate >= 85) {
                    label.textContent = 'Good';
                    label.className = 'text-blue';
                } else {
                    label.textContent = 'Needs attention';
                    label.className = 'text-orange';
                }

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load notification history
        async function loadHistory() {
            try {
                const [notificationsRes, schedulesRes, membersRes] = await Promise.all([
                    fetch(`${API_BASE}/notifications/recent?limit=50`, { credentials: 'include' }),
                    fetch(`${API_BASE}/schedules/upcoming?weeks=8`, { credentials: 'include' }),
                    fetch(`${API_BASE}/team-members/?active_only=true`, { credentials: 'include' })
                ]);

                if (!notificationsRes.ok) {
                    throw new Error('Failed to fetch notifications');
                }

                const notifications = await notificationsRes.json();
                const schedules = await schedulesRes.json();
                const members = await membersRes.json();

                const tbody = document.getElementById('historyTableBody');

                if (notifications.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No notifications sent yet</td></tr>';
                    document.getElementById('historyCount').textContent = 'Showing 0 notifications';
                    return;
                }

                tbody.innerHTML = '';

                notifications.forEach(notification => {
                    const schedule = schedules.find(s => s.id === notification.schedule_id);
                    const member = schedule ? members.find(m => m.id === schedule.team_member_id) : null;

                    // Use snapshot data from notification if available, fallback to current member data
                    const recipientName = notification.recipient_name || (member ? member.name : 'Unknown');
                    const recipientPhone = notification.recipient_phone || (member ? member.phone : null);

                    const row = document.createElement('tr');

                    // Timestamp
                    const timestampCell = document.createElement('td');
                    timestampCell.innerHTML = `<span class="text-muted">${formatDateTime(notification.sent_at)}</span>`;
                    row.appendChild(timestampCell);

                    // Recipient (use snapshot or current data)
                    const recipientCell = document.createElement('td');
                    if (recipientName !== 'Unknown') {
                        // Find member by schedule lookup OR by name from snapshot data
                        let memberForColor = member;
                        if (!memberForColor && recipientName) {
                            // Try to find member by name (from snapshot)
                            memberForColor = members.find(m => m.name === recipientName);
                        }
                        const colorClass = memberForColor ? getTeamColor(memberForColor.id, members) : 'team-color-1';
                        // Extract initials from name
                        const initials = recipientName.split(' ').map(n => n[0]).join('').toUpperCase();
                        recipientCell.innerHTML = `
                            <div class="d-flex align-items-center">
                                <span class="avatar avatar-sm me-2 ${colorClass}">${initials}</span>
                                ${recipientName}
                            </div>
                        `;
                    } else {
                        recipientCell.textContent = 'Unknown';
                    }
                    row.appendChild(recipientCell);

                    // Phone (use snapshot or current data)
                    const phoneCell = document.createElement('td');
                    phoneCell.textContent = recipientPhone ? maskPhone(recipientPhone) : '-';
                    row.appendChild(phoneCell);

                    // Status
                    const statusCell = document.createElement('td');
                    let badgeClass = 'bg-secondary';
                    if (notification.status === 'sent' || notification.status === 'delivered') {
                        badgeClass = 'bg-success';
                    } else if (notification.status === 'failed' || notification.status === 'undelivered') {
                        badgeClass = 'bg-danger';
                    } else if (notification.status === 'pending') {
                        badgeClass = 'bg-warning';
                    }
                    statusCell.innerHTML = `<span class="badge ${badgeClass}">${notification.status}</span>`;
                    row.appendChild(statusCell);

                    // Twilio SID (clickable link to Twilio Console)
                    const sidCell = document.createElement('td');
                    if (notification.twilio_sid) {
                        const twilioUrl = `https://console.twilio.com/us1/monitor/logs/sms/${notification.twilio_sid}`;
                        sidCell.innerHTML = `<a href="${twilioUrl}" target="_blank" rel="noopener noreferrer" class="text-decoration-none">
                            <code class="text-primary">${notification.twilio_sid.substring(0, 15)}...</code>
                            <i class="ti ti-external-link ms-1" style="font-size: 0.75rem;"></i>
                        </a>`;
                    } else {
                        sidCell.textContent = '-';
                    }
                    row.appendChild(sidCell);

                    // Actions column
                    const actionsCell = document.createElement('td');
                    if (notification.twilio_sid) {
                        actionsCell.innerHTML = `
                            <button class="btn btn-sm btn-outline-primary" onclick="viewMessageDetails(${notification.id})" title="View message details from Twilio">
                                <i class="ti ti-eye"></i>
                            </button>
                        `;
                    } else {
                        actionsCell.textContent = '-';
                    }
                    row.appendChild(actionsCell);

                    tbody.appendChild(row);
                });

                document.getElementById('historyCount').textContent = `Showing ${notifications.length} notifications`;

            } catch (error) {
                console.error('Error loading history:', error);
                const tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading notification history</td></tr>';
            }
        }

        // View Message Details from Twilio
        async function viewMessageDetails(notificationId) {
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('messageDetailsModal'));
            modal.show();

            // Reset states
            document.getElementById('messageDetailsLoading').style.display = 'block';
            document.getElementById('messageDetailsError').style.display = 'none';
            document.getElementById('messageDetailsContent').style.display = 'none';

            try {
                const response = await fetch(`${API_BASE}/notifications/${notificationId}/message`, {
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || `HTTP ${response.status}: Failed to fetch message details`);
                }

                const data = await response.json();

                // Hide loading, show content
                document.getElementById('messageDetailsLoading').style.display = 'none';
                document.getElementById('messageDetailsContent').style.display = 'block';

                // Populate Message Body
                document.getElementById('messageBody').textContent = data.body || 'No message body available';

                // Populate Delivery Information
                const statusBadge = getStatusBadge(data.status);
                document.getElementById('messageStatus').innerHTML = statusBadge;
                document.getElementById('messageDirection').textContent = data.direction || '-';
                document.getElementById('messageDateSent').textContent = data.date_sent ? formatDateTime(data.date_sent) : '-';
                document.getElementById('messageDateUpdated').textContent = data.date_updated ? formatDateTime(data.date_updated) : '-';
                document.getElementById('messageFrom').textContent = data.from || '-';
                document.getElementById('messageTo').textContent = data.to || '-';

                // Populate Technical Details
                document.getElementById('messageSid').textContent = data.sid || '-';
                document.getElementById('messageSegments').textContent = data.num_segments || '1';
                document.getElementById('messagePrice').textContent = data.price ? `$${Math.abs(data.price)} ${data.price_unit || 'USD'}` : '-';
                document.getElementById('messageErrorCode').textContent = data.error_code || 'None';

                // Show error message if present
                if (data.error_message) {
                    document.getElementById('messageErrorMessage').textContent = data.error_message;
                    document.getElementById('messageErrorMessageContainer').style.display = 'block';
                } else {
                    document.getElementById('messageErrorMessageContainer').style.display = 'none';
                }

            } catch (error) {
                console.error('Error fetching message details:', error);
                document.getElementById('messageDetailsLoading').style.display = 'none';
                document.getElementById('messageDetailsError').style.display = 'block';
                document.getElementById('messageDetailsErrorText').textContent = error.message;
            }
        }

        function getStatusBadge(status) {
            const statusMap = {
                'queued': 'bg-secondary',
                'sent': 'bg-info',
                'delivered': 'bg-success',
                'failed': 'bg-danger',
                'undelivered': 'bg-danger',
                'receiving': 'bg-warning',
                'received': 'bg-success'
            };
            const badgeClass = statusMap[status] || 'bg-secondary';
            return `<span class="badge ${badgeClass}">${status}</span>`;
        }

        // SMS Template Management
        const DEFAULT_TEMPLATE = `WhoseOnFirst Alert

Hi {name}, you are now on-call starting at {start_time} CST until {end_time} CST.

Your shift lasts {duration}. Thank you for being available!`;

        async function loadTemplate() {
            try {
                const response = await fetch(`${API_BASE}/settings/sms-template`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch SMS template');
                }

                const data = await response.json();
                const template = data.template || DEFAULT_TEMPLATE;
                document.getElementById('templatePreview').textContent = template;
                return template;

            } catch (error) {
                console.error('Error loading SMS template:', error);
                // Fallback to default template
                document.getElementById('templatePreview').textContent = DEFAULT_TEMPLATE;
                return DEFAULT_TEMPLATE;
            }
        }

        async function saveTemplate(template) {
            try {
                const response = await fetch(`${API_BASE}/settings/sms-template`, {
                    method: 'PUT',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        template: template
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to save template');
                }

                const data = await response.json();
                document.getElementById('templatePreview').textContent = data.template;
                return true;

            } catch (error) {
                console.error('Error saving SMS template:', error);
                throw error;  // Re-throw so caller can handle
            }
        }

        function updateCharacterCount() {
            const text = document.getElementById('templateEditor').value;
            const length = text.length;
            document.getElementById('charCount').textContent = length;

            // Calculate SMS count (160 chars per SMS for standard messages)
            const smsCount = Math.ceil(length / 160) || 1;
            document.getElementById('smsCount').textContent = `(${smsCount} SMS)`;
        }

        // Main data loading function (called after auth check)
        async function loadNotificationsData() {
            await loadTemplate();
            await loadStats();
            await loadHistory();
        }

        // Authentication guard - FIRST thing to execute on page load
        window.addEventListener('sidebarLoaded', async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/auth/me`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    // Not authenticated - redirect immediately
                    window.location.href = '/login.html';
                    return;
                }

                currentUser = await response.json();

                // Update user info display
                document.getElementById('usernameDisplay').textContent = currentUser.username;

                // Set role display and icon based on user role
                const roleIcon = document.getElementById('userRoleIcon').querySelector('i');
                if (currentUser.role === 'admin') {
                    document.getElementById('userRoleDisplay').textContent = 'Administrator';
                    roleIcon.className = 'ti ti-shield-check';
                } else {
                    document.getElementById('userRoleDisplay').textContent = 'Viewer';
                    roleIcon.className = 'ti ti-eye';
                }

                // Hide admin-only features for viewers
                if (currentUser.role === 'viewer') {
                    const adminButtons = document.querySelectorAll('.admin-only');
                    adminButtons.forEach(btn => btn.style.display = 'none');

                    // Disable template editing
                    document.getElementById('templateEditor').disabled = true;
                }

                // Wire up logout button
                document.getElementById('logoutBtn').addEventListener('click', async function(e) {
                    e.preventDefault();
                    try {
                        await fetch(`${API_BASE_URL}/api/v1/auth/logout`, {
                            method: 'POST',
                            credentials: 'include'
                        });
                    } catch (error) {
                        console.error('Logout error:', error);
                    }
                    window.location.href = '/login.html';
                });

                // Load all data
                await loadNotificationsData();

                // Setup event listeners
                setupEventListeners(currentUser);
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login.html';
            }
        });

        function setupEventListeners(user) {
            // Refresh history
            document.getElementById('refreshHistory').addEventListener('click', function() {
                loadHistory();
            });

            // Template editing (admin only)
            if (user.role === 'admin') {
                // Edit Template Button
                document.getElementById('editTemplateBtn').addEventListener('click', async function() {
                    const currentTemplate = await loadTemplate();
                    document.getElementById('templateEditor').value = currentTemplate;
                    updateCharacterCount();

                    document.getElementById('templateReadView').style.display = 'none';
                    document.getElementById('templateEditView').style.display = 'block';
                    this.style.display = 'none';
                });

                // Save Template Button
                document.getElementById('saveTemplateBtn').addEventListener('click', async function() {
                    const newTemplate = document.getElementById('templateEditor').value.trim();

                    if (!newTemplate) {
                        alert('Template cannot be empty');
                        return;
                    }

                    // Validate template has at least one variable
                    if (!newTemplate.includes('{')) {
                        if (!confirm('Warning: Template has no variables. Continue anyway?')) {
                            return;
                        }
                    }

                    // Disable button during save
                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

                    try {
                        await saveTemplate(newTemplate);

                        document.getElementById('templateReadView').style.display = 'block';
                        document.getElementById('templateEditView').style.display = 'none';
                        document.getElementById('editTemplateBtn').style.display = 'inline-block';

                        alert('✅ Template saved successfully!');

                    } catch (error) {
                        alert('❌ Failed to save template: ' + error.message);
                    } finally {
                        // Re-enable button
                        this.disabled = false;
                        this.innerHTML = '<i class="ti ti-check"></i> Save Template';
                    }
                });

                // Cancel Template Button
                document.getElementById('cancelTemplateBtn').addEventListener('click', function() {
                    document.getElementById('templateReadView').style.display = 'block';
                    document.getElementById('templateEditView').style.display = 'none';
                    document.getElementById('editTemplateBtn').style.display = 'inline-block';
                });

                // Reset Template Button
                document.getElementById('resetTemplateBtn').addEventListener('click', function() {
                    if (confirm('Reset to default template? This cannot be undone.')) {
                        document.getElementById('templateEditor').value = DEFAULT_TEMPLATE;
                        updateCharacterCount();
                    }
                });

                // Character counter
                document.getElementById('templateEditor').addEventListener('input', updateCharacterCount);
            }

            // Manual Notification Modal (admin only)
            if (user.role === 'admin') {
                setupManualNotificationModal();
            }
        }

        // Manual Notification Modal Functions
        let activeTeamMembers = [];
        let currentOnCallMemberId = null;

        async function setupManualNotificationModal() {
            // Load active team members
            await loadActiveTeamMembers();

            // Get current on-call member
            await loadCurrentOnCallMember();

            // Wire up the "Send Test SMS" button to open modal
            const sendTestBtn = document.getElementById('sendTestSMS');
            if (sendTestBtn) {
                // Remove old event listener by cloning the button
                const newSendTestBtn = sendTestBtn.cloneNode(true);
                sendTestBtn.parentNode.replaceChild(newSendTestBtn, sendTestBtn);

                newSendTestBtn.addEventListener('click', function() {
                    openManualNotificationModal();
                });
            }

            // Character counter for manual message
            document.getElementById('manualMessageText').addEventListener('input', updateManualCharacterCount);

            // Preview updater
            document.getElementById('manualMessageText').addEventListener('input', updateManualMessagePreview);
            document.getElementById('manualRecipientSelect').addEventListener('change', updateManualMessagePreview);

            // Send Manual Notification Button
            document.getElementById('sendManualNotificationBtn').addEventListener('click', sendManualNotification);
        }

        async function loadActiveTeamMembers() {
            try {
                const response = await fetch(`${API_BASE}/team-members/?active_only=true`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch team members');
                }

                activeTeamMembers = await response.json();
            } catch (error) {
                console.error('Error loading team members:', error);
                activeTeamMembers = [];
            }
        }

        async function loadCurrentOnCallMember() {
            try {
                const response = await fetch(`${API_BASE}/schedules/current`, {
                    credentials: 'include'
                });

                if (response.ok) {
                    const currentSchedules = await response.json();
                    if (currentSchedules.length > 0) {
                        currentOnCallMemberId = currentSchedules[0].team_member_id;
                    }
                }
            } catch (error) {
                console.error('Error loading current on-call member:', error);
                currentOnCallMemberId = null;
            }
        }

        function openManualNotificationModal() {
            // Populate recipient dropdown
            const recipientSelect = document.getElementById('manualRecipientSelect');
            recipientSelect.innerHTML = '<option value="">-- Select a team member --</option>';

            activeTeamMembers.forEach(member => {
                const option = document.createElement('option');
                option.value = member.id;
                option.textContent = member.name;

                // Pre-select current on-call member
                if (member.id === currentOnCallMemberId) {
                    option.selected = true;
                }

                recipientSelect.appendChild(option);
            });

            // Set default message
            const defaultMessage = `WhoseOnFirst Alert

Hi {name}, this is a test notification from the WhoseOnFirst system.

Thank you!`;

            document.getElementById('manualMessageText').value = defaultMessage;

            // Reset states
            document.getElementById('manualNotificationError').style.display = 'none';
            document.getElementById('manualNotificationSuccess').style.display = 'none';
            document.getElementById('sendManualNotificationBtn').disabled = false;

            // Update counters and preview
            updateManualCharacterCount();
            updateManualMessagePreview();

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('manualNotificationModal'));
            modal.show();
        }

        function updateManualCharacterCount() {
            const text = document.getElementById('manualMessageText').value;
            const length = text.length;

            document.getElementById('manualCharCount').textContent = length;

            // Calculate SMS count (160 chars per SMS for standard messages)
            const smsCount = Math.ceil(length / 160) || 1;
            document.getElementById('manualSmsCount').textContent = smsCount;

            // Update progress bar
            const progress = Math.min((length / 160) * 100, 100);
            const progressBar = document.getElementById('manualCharProgress');
            progressBar.style.width = progress + '%';

            // Color coding
            if (length <= 160) {
                progressBar.className = 'progress-bar bg-success';
            } else if (length <= 320) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-danger';
            }
        }

        function updateManualMessagePreview() {
            const messageText = document.getElementById('manualMessageText').value;
            const recipientSelect = document.getElementById('manualRecipientSelect');
            const selectedMemberId = parseInt(recipientSelect.value);

            let previewText = messageText;

            // Replace {name} placeholder with selected member's name
            if (selectedMemberId) {
                const member = activeTeamMembers.find(m => m.id === selectedMemberId);
                if (member) {
                    previewText = previewText.replace(/\{name\}/g, member.name);
                }
            }

            document.getElementById('manualMessagePreview').textContent = previewText || '(Message preview will appear here)';
        }

        async function sendManualNotification() {
            const recipientSelect = document.getElementById('manualRecipientSelect');
            const messageText = document.getElementById('manualMessageText').value.trim();
            const selectedMemberId = parseInt(recipientSelect.value);

            // Reset alerts
            document.getElementById('manualNotificationError').style.display = 'none';
            document.getElementById('manualNotificationSuccess').style.display = 'none';

            // Validation
            if (!selectedMemberId) {
                document.getElementById('manualNotificationErrorText').textContent = 'Please select a recipient';
                document.getElementById('manualNotificationError').style.display = 'block';
                return;
            }

            if (!messageText) {
                document.getElementById('manualNotificationErrorText').textContent = 'Message cannot be empty';
                document.getElementById('manualNotificationError').style.display = 'block';
                return;
            }

            // Disable send button
            const sendBtn = document.getElementById('sendManualNotificationBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';

            try {
                const response = await fetch(`${API_BASE}/notifications/send-manual`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        team_member_id: selectedMemberId,
                        message: messageText
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.detail || 'Failed to send notification');
                }

                if (result.success) {
                    // Show success message
                    document.getElementById('manualNotificationSuccessText').textContent =
                        `✅ ${result.message} (SID: ${result.twilio_sid})`;
                    document.getElementById('manualNotificationSuccess').style.display = 'block';

                    // Reload notification history
                    setTimeout(() => {
                        loadStats();
                        loadHistory();

                        // Close modal after 2 seconds
                        setTimeout(() => {
                            const modal = bootstrap.Modal.getInstance(document.getElementById('manualNotificationModal'));
                            if (modal) {
                                modal.hide();
                            }
                        }, 2000);
                    }, 500);
                } else {
                    throw new Error(result.error || 'Failed to send SMS');
                }

            } catch (error) {
                console.error('Error sending manual notification:', error);
                document.getElementById('manualNotificationErrorText').textContent = error.message;
                document.getElementById('manualNotificationError').style.display = 'block';

                // Re-enable button
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="ti ti-send me-2"></i>Send SMS';
            }
        }
    </script>

    <!-- Bootstrap JS (required for modal functionality) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Tabler JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>
</body>
</html>
