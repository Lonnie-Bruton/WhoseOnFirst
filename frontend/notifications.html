<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhoseOnFirst - Notifications</title>

    <!-- Tabler CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">
    <!-- Tabler Icons -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css" rel="stylesheet">

    <!-- Load sidebar component -->
    <script src="/js/sidebar-loader.js" defer></script>

    <style>
        /* Custom Logo Styles */
        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-svg {
            width: 32px;
            height: 32px;
        }

        /* Enhanced Cards */
        .stat-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Team Member Colors - 16 unique WCAG AA compliant colors */
        .team-color-1  { background-color: #1e40af; color: white; } /* Blue */
        .team-color-2  { background-color: #dc2626; color: white; } /* Red */
        .team-color-3  { background-color: #059669; color: white; } /* Green */
        .team-color-4  { background-color: #d97706; color: white; } /* Amber */
        .team-color-5  { background-color: #9333ea; color: white; } /* Purple */
        .team-color-6  { background-color: #0891b2; color: white; } /* Cyan */
        .team-color-7  { background-color: #ea580c; color: white; } /* Orange */
        .team-color-8  { background-color: #be185d; color: white; } /* Pink */
        .team-color-9  { background-color: #0f766e; color: white; } /* Teal */
        .team-color-10 { background-color: #a16207; color: white; } /* Yellow */
        .team-color-11 { background-color: #6b21a8; color: white; } /* Deep Purple */
        .team-color-12 { background-color: #b91c1c; color: white; } /* Dark Red */
        .team-color-13 { background-color: #1e3a8a; color: white; } /* Navy */
        .team-color-14 { background-color: #15803d; color: white; } /* Forest Green */
        .team-color-15 { background-color: #c2410c; color: white; } /* Rust */
        .team-color-16 { background-color: #7e22ce; color: white; } /* Violet */
    </style>
</head>
<body data-page="notifications">
    <div class="page">
        <!-- Sidebar Component (loaded via JavaScript) -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <div class="page-wrapper">
            <!-- Page Header -->
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <div class="page-pretitle">SMS Management</div>
                            <h2 class="page-title">Notifications</h2>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">
                                <button class="btn btn-primary admin-only" id="sendTestSMS">
                                    <i class="ti ti-send me-2"></i>
                                    Send Test SMS
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Page Body -->
            <div class="page-body">
                <div class="container-xl">
                    <!-- Stats Cards -->
                    <div class="row row-deck row-cards mb-4">
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Total Sent</div>
                                        <div class="ms-auto">
                                            <span class="bg-blue text-white avatar">
                                                <i class="ti ti-send"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="h1 mb-3" id="totalSent">-</div>
                                    <div class="d-flex mb-2">
                                        <div class="text-muted">All time notifications</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">This Month</div>
                                        <div class="ms-auto">
                                            <span class="bg-green text-white avatar">
                                                <i class="ti ti-calendar"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="h1 mb-3" id="thisMonth">-</div>
                                    <div class="d-flex mb-2">
                                        <div class="text-muted">Current month</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Delivery Rate</div>
                                        <div class="ms-auto">
                                            <span class="bg-success text-white avatar">
                                                <i class="ti ti-check"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-baseline">
                                        <div class="h1 mb-0 me-2" id="deliveryRate">-</div>
                                        <div class="me-auto">
                                            <span class="text-muted" id="deliveryLabel">Calculating...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Failed</div>
                                        <div class="ms-auto">
                                            <span class="bg-red text-white avatar">
                                                <i class="ti ti-alert-circle"></i>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="h1 mb-3" id="failedCount">-</div>
                                    <div class="d-flex mb-2">
                                        <div class="text-muted">Requires attention</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SMS Template (Editable) -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="ti ti-file-text me-2"></i>
                                        SMS Template
                                    </h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-primary admin-only" id="editTemplateBtn">
                                            <i class="ti ti-edit"></i>
                                            Edit Template
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info mb-3">
                                        <i class="ti ti-info-circle me-2"></i>
                                        This template is automatically sent to team members at 8:00 AM CST when their shift starts.
                                    </div>

                                    <!-- Read-Only View -->
                                    <div id="templateReadView">
                                        <div class="border p-3 rounded bg-light">
                                            <div class="mb-2"><strong>Send Time:</strong> 8:00 AM CST</div>
                                            <div class="mb-2"><strong>Status:</strong> <span class="badge bg-success">Active</span></div>
                                            <hr>
                                            <div class="font-monospace" id="templatePreview" style="white-space: pre-wrap;"></div>
                                        </div>
                                        <div class="text-muted mt-2">
                                            <small>Available variables: {name}, {start_time}, {end_time}, {duration}</small>
                                        </div>
                                    </div>

                                    <!-- Edit View (Hidden by default) -->
                                    <div id="templateEditView" style="display: none;">
                                        <div class="mb-3">
                                            <label class="form-label">Message Template</label>
                                            <textarea class="form-control font-monospace" id="templateEditor" rows="6"
                                                      placeholder="Enter your SMS template..."></textarea>
                                            <div class="form-text">
                                                Available variables: {name}, {start_time}, {end_time}, {duration}
                                            </div>
                                            <div class="form-text mt-2">
                                                <strong>Character count:</strong> <span id="charCount">0</span> / 160
                                                <span id="smsCount" class="ms-2">(1 SMS)</span>
                                            </div>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-success admin-only" id="saveTemplateBtn">
                                                <i class="ti ti-check"></i>
                                                Save Template
                                            </button>
                                            <button class="btn btn-secondary" id="cancelTemplateBtn">
                                                <i class="ti ti-x"></i>
                                                Cancel
                                            </button>
                                            <button class="btn btn-outline-primary ms-auto admin-only" id="resetTemplateBtn">
                                                <i class="ti ti-refresh"></i>
                                                Reset to Default
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notification History -->
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="ti ti-history me-2"></i>
                                        Notification History
                                    </h3>
                                    <div class="card-actions">
                                        <button class="btn btn-sm btn-outline-primary" id="refreshHistory">
                                            <i class="ti ti-refresh"></i>
                                            Refresh
                                        </button>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table card-table table-vcenter" id="notificationTable">
                                        <thead>
                                            <tr>
                                                <th>Timestamp</th>
                                                <th>Recipient</th>
                                                <th>Phone</th>
                                                <th>Status</th>
                                                <th>Twilio SID</th>
                                            </tr>
                                        </thead>
                                        <tbody id="historyTableBody">
                                            <tr>
                                                <td colspan="5" class="text-center text-muted">Loading notification history...</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="card-footer">
                                    <div class="text-muted" id="historyCount">Showing 0 notifications</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
        </div>
    </div>

    <!-- Tabler JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/js/tabler.min.js"></script>

    <script>
        const API_BASE_URL = '';  // Use same origin as current page
        const API_BASE = '/api/v1';
        let currentUser = null;

        // Team member color mapping (1-16 unique colors)
        const TEAM_COLORS = [
            'team-color-1',  'team-color-2',  'team-color-3',  'team-color-4',
            'team-color-5',  'team-color-6',  'team-color-7',  'team-color-8',
            'team-color-9',  'team-color-10', 'team-color-11', 'team-color-12',
            'team-color-13', 'team-color-14', 'team-color-15', 'team-color-16'
        ];

        // Get color class for team member
        function getTeamColor(memberId, allMembers) {
            const sorted = [...allMembers].sort((a, b) => a.id - b.id);
            const index = sorted.findIndex(m => m.id === memberId);
            return TEAM_COLORS[index % TEAM_COLORS.length];
        }

        // Format date/time
        function formatDateTime(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        // Mask phone number
        function maskPhone(phone) {
            if (!phone || phone.length < 4) return phone;
            return phone.slice(0, -4) + 'XXXX';
        }

        // Load notification stats
        async function loadStats() {
            try {
                const response = await fetch(`${API_BASE}/notifications/stats?days=30`, {
                    credentials: 'include'
                });
                if (!response.ok) {
                    throw new Error('Failed to fetch stats');
                }

                const stats = await response.json();

                document.getElementById('totalSent').textContent = stats.total_sent;
                document.getElementById('thisMonth').textContent = stats.this_month;
                document.getElementById('deliveryRate').textContent = stats.delivery_rate.toFixed(1) + '%';
                document.getElementById('failedCount').textContent = stats.failed_count;

                // Update delivery label based on rate
                const label = document.getElementById('deliveryLabel');
                if (stats.delivery_rate >= 95) {
                    label.textContent = 'Excellent';
                    label.className = 'text-green';
                } else if (stats.delivery_rate >= 85) {
                    label.textContent = 'Good';
                    label.className = 'text-blue';
                } else {
                    label.textContent = 'Needs attention';
                    label.className = 'text-orange';
                }

            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load notification history
        async function loadHistory() {
            try {
                const [notificationsRes, schedulesRes, membersRes] = await Promise.all([
                    fetch(`${API_BASE}/notifications/recent?limit=50`, { credentials: 'include' }),
                    fetch(`${API_BASE}/schedules/upcoming?weeks=8`, { credentials: 'include' }),
                    fetch(`${API_BASE}/team-members/`, { credentials: 'include' })
                ]);

                if (!notificationsRes.ok) {
                    throw new Error('Failed to fetch notifications');
                }

                const notifications = await notificationsRes.json();
                const schedules = await schedulesRes.json();
                const members = await membersRes.json();

                const tbody = document.getElementById('historyTableBody');

                if (notifications.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No notifications sent yet</td></tr>';
                    document.getElementById('historyCount').textContent = 'Showing 0 notifications';
                    return;
                }

                tbody.innerHTML = '';

                notifications.forEach(notification => {
                    const schedule = schedules.find(s => s.id === notification.schedule_id);
                    const member = schedule ? members.find(m => m.id === schedule.team_member_id) : null;

                    const row = document.createElement('tr');

                    // Timestamp
                    const timestampCell = document.createElement('td');
                    timestampCell.innerHTML = `<span class="text-muted">${formatDateTime(notification.sent_at)}</span>`;
                    row.appendChild(timestampCell);

                    // Recipient
                    const recipientCell = document.createElement('td');
                    if (member) {
                        const colorClass = getTeamColor(member.id, members);
                        recipientCell.innerHTML = `
                            <div class="d-flex align-items-center">
                                <span class="avatar avatar-sm me-2 ${colorClass}"></span>
                                ${member.name}
                            </div>
                        `;
                    } else {
                        recipientCell.textContent = 'Unknown';
                    }
                    row.appendChild(recipientCell);

                    // Phone
                    const phoneCell = document.createElement('td');
                    phoneCell.textContent = member ? maskPhone(member.phone) : '-';
                    row.appendChild(phoneCell);

                    // Status
                    const statusCell = document.createElement('td');
                    let badgeClass = 'bg-secondary';
                    if (notification.status === 'sent' || notification.status === 'delivered') {
                        badgeClass = 'bg-success';
                    } else if (notification.status === 'failed' || notification.status === 'undelivered') {
                        badgeClass = 'bg-danger';
                    } else if (notification.status === 'pending') {
                        badgeClass = 'bg-warning';
                    }
                    statusCell.innerHTML = `<span class="badge ${badgeClass}">${notification.status}</span>`;
                    row.appendChild(statusCell);

                    // Twilio SID
                    const sidCell = document.createElement('td');
                    if (notification.twilio_sid) {
                        sidCell.innerHTML = `<code>${notification.twilio_sid.substring(0, 15)}...</code>`;
                    } else {
                        sidCell.textContent = '-';
                    }
                    row.appendChild(sidCell);

                    tbody.appendChild(row);
                });

                document.getElementById('historyCount').textContent = `Showing ${notifications.length} notifications`;

            } catch (error) {
                console.error('Error loading history:', error);
                const tbody = document.getElementById('historyTableBody');
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading notification history</td></tr>';
            }
        }

        // SMS Template Management
        const DEFAULT_TEMPLATE = `WhoseOnFirst Alert

Hi {name}, you are now on-call starting at {start_time} CST until {end_time} CST.

Your shift lasts {duration}. Thank you for being available!`;

        function loadTemplate() {
            const template = localStorage.getItem('smsTemplate') || DEFAULT_TEMPLATE;
            document.getElementById('templatePreview').textContent = template;
            return template;
        }

        function saveTemplate(template) {
            localStorage.setItem('smsTemplate', template);
            document.getElementById('templatePreview').textContent = template;
        }

        function updateCharacterCount() {
            const text = document.getElementById('templateEditor').value;
            const length = text.length;
            document.getElementById('charCount').textContent = length;

            // Calculate SMS count (160 chars per SMS for standard messages)
            const smsCount = Math.ceil(length / 160) || 1;
            document.getElementById('smsCount').textContent = `(${smsCount} SMS)`;
        }

        // Main data loading function (called after auth check)
        async function loadNotificationsData() {
            loadTemplate();
            await loadStats();
            await loadHistory();
        }

        // Authentication guard - FIRST thing to execute on page load
        window.addEventListener('sidebarLoaded', async function() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/auth/me`, {
                    credentials: 'include'
                });

                if (!response.ok) {
                    // Not authenticated - redirect immediately
                    window.location.href = '/login.html';
                    return;
                }

                currentUser = await response.json();

                // Update user info display
                document.getElementById('usernameDisplay').textContent = currentUser.username;

                // Set role display and icon based on user role
                const roleIcon = document.getElementById('userRoleIcon').querySelector('i');
                if (currentUser.role === 'admin') {
                    document.getElementById('userRoleDisplay').textContent = 'Administrator';
                    roleIcon.className = 'ti ti-shield-check';
                } else {
                    document.getElementById('userRoleDisplay').textContent = 'Viewer';
                    roleIcon.className = 'ti ti-eye';
                }

                // Hide admin-only features for viewers
                if (currentUser.role === 'viewer') {
                    const adminButtons = document.querySelectorAll('.admin-only');
                    adminButtons.forEach(btn => btn.style.display = 'none');

                    // Disable template editing
                    document.getElementById('templateEditor').disabled = true;
                }

                // Wire up logout button
                document.getElementById('logoutBtn').addEventListener('click', async function(e) {
                    e.preventDefault();
                    try {
                        await fetch(`${API_BASE_URL}/api/v1/auth/logout`, {
                            method: 'POST',
                            credentials: 'include'
                        });
                    } catch (error) {
                        console.error('Logout error:', error);
                    }
                    window.location.href = '/login.html';
                });

                // Load all data
                await loadNotificationsData();

                // Setup event listeners
                setupEventListeners(currentUser);
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/login.html';
            }
        });

        function setupEventListeners(user) {
            // Send test SMS (admin only)
            const sendTestBtn = document.getElementById('sendTestSMS');
            if (sendTestBtn && user.role === 'admin') {
                sendTestBtn.addEventListener('click', async function() {
                    if (!confirm('Send test SMS to all team members on-call today?')) {
                        return;
                    }

                    this.disabled = true;
                    this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';

                    try {
                        const response = await fetch(`${API_BASE}/schedules/notifications/trigger`, {
                            method: 'POST',
                            credentials: 'include'
                        });

                        if (response.ok) {
                            const result = await response.json();
                            alert(`✅ Sent ${result.successful || 0} SMS notification(s) successfully!`);

                            // Reload data
                            loadStats();
                            loadHistory();
                        } else {
                            const error = await response.json();
                            alert('❌ Failed to send notifications: ' + (error.detail || 'Unknown error'));
                        }
                    } catch (error) {
                        alert('❌ Error: ' + error.message);
                    } finally {
                        this.disabled = false;
                        this.innerHTML = '<i class="ti ti-send me-2"></i>Send Test SMS';
                    }
                });
            }

            // Refresh history
            document.getElementById('refreshHistory').addEventListener('click', function() {
                loadHistory();
            });

            // Template editing (admin only)
            if (user.role === 'admin') {
                // Edit Template Button
                document.getElementById('editTemplateBtn').addEventListener('click', function() {
                    const currentTemplate = loadTemplate();
                    document.getElementById('templateEditor').value = currentTemplate;
                    updateCharacterCount();

                    document.getElementById('templateReadView').style.display = 'none';
                    document.getElementById('templateEditView').style.display = 'block';
                    this.style.display = 'none';
                });

                // Save Template Button
                document.getElementById('saveTemplateBtn').addEventListener('click', function() {
                    const newTemplate = document.getElementById('templateEditor').value.trim();

                    if (!newTemplate) {
                        alert('Template cannot be empty');
                        return;
                    }

                    // Validate template has at least one variable
                    if (!newTemplate.includes('{')) {
                        if (!confirm('Warning: Template has no variables. Continue anyway?')) {
                            return;
                        }
                    }

                    saveTemplate(newTemplate);

                    document.getElementById('templateReadView').style.display = 'block';
                    document.getElementById('templateEditView').style.display = 'none';
                    document.getElementById('editTemplateBtn').style.display = 'inline-block';

                    alert('✅ Template saved successfully!');
                });

                // Cancel Template Button
                document.getElementById('cancelTemplateBtn').addEventListener('click', function() {
                    document.getElementById('templateReadView').style.display = 'block';
                    document.getElementById('templateEditView').style.display = 'none';
                    document.getElementById('editTemplateBtn').style.display = 'inline-block';
                });

                // Reset Template Button
                document.getElementById('resetTemplateBtn').addEventListener('click', function() {
                    if (confirm('Reset to default template? This cannot be undone.')) {
                        document.getElementById('templateEditor').value = DEFAULT_TEMPLATE;
                        updateCharacterCount();
                    }
                });

                // Character counter
                document.getElementById('templateEditor').addEventListener('input', updateCharacterCount);
            }
        }
    </script>
</body>
</html>
